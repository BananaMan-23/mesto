(()=>{"use strict";class e{constructor(e,t){this._inputSelector=e.inputSelector,this._submitButtonSelector=e.submitButtonSelector,this._inactiveButtonClass=e.inactiveButtonClass,this._inputErrorClass=e.inputErrorClass,this._errorClass=e.errorClass,this._formElement=t}disableSubmitButton(){this._buttonElement.classList.add(this._inactiveButtonClass),this._buttonElement.disbaled=!0}_activeError(e,t){const s=this._formElement.querySelector(`#${e.id}-error`);e.classList.add(this._inputErrorClass),s.classList.add(this._errorClass),s.textContent=t}_inactiveError(e){const t=this._formElement.querySelector(`#${e.id}-error`);e.classList.remove(this._inputErrorClass),t.classList.remove(this._errorClass),t.textContent=""}_checkInputValidity(e){e.validity.valid?this._inactiveError(e):this._activeError(e,e.validationMessage)}_hasInvalidInput(e){return e.some((e=>!e.validity.valid))}_toggleButtonState(e,t){this._hasInvalidInput(e)?this.disableSubmitButton():(t.classList.remove(this._inactiveButtonClass),t.disabled=!1)}_setIventListeners(){this._inputList=Array.from(this._formElement.querySelectorAll(this._inputSelector)),this._buttonElement=this._formElement.querySelector(this._submitButtonSelector),this._toggleButtonState(this._inputList,this._buttonElement),this._inputList.forEach((e=>{e.addEventListener("input",(()=>{this._checkInputValidity(e),this._toggleButtonState(this._inputList,this._buttonElement)}))}))}enableValidation(){this._setIventListeners()}}class t{constructor(e,t,s,i){let{data:n,handleCardClick:r}=e;this._name=n.name,this._link=n.link,this._handleCardClick=r,this._cardSelector=t,this._deleteOpenPopup=s,this._myId=n.myid,this._ownerId=n.owner._id,this._likes=n.likes,this._likeLength=n.likes.length,this._likeSelector=i,this._cardId=n._id}_getTemplate(){this._card=document.querySelector(this._cardSelector).content.querySelector(".element").cloneNode(!0)}renderCard(){return this._getTemplate(),this._setEventListeners(),this._checkTreshButton(),this._checkLike(),this._img.alt=this._name,this._img.src=this._link,this._card.querySelector(".element__group-subtitle").textContent=this._name,this._card}_setEventListeners(){this._img=this._card.querySelector(".element__image"),this._like=this._card.querySelector(".element__group-like"),this._count=this._card.querySelector(".elements__like-count"),this._like.addEventListener("click",(()=>{this._handleLikeCard()})),this._card.querySelector(".element__trash").addEventListener("click",(()=>{this._handleRemoveCard()})),this._img.addEventListener("click",(()=>{this._handleCardClick({name:this._name,link:this._link})}))}_handleLikeCard(){this._likeSelector(this._like,this._cardId)}_handleRemoveCard(){this._deleteOpenPopup({card:this,cardId:this._cardId})}removeCard(){this._card.remove(),this._card=null}_checkTreshButton(){return this._myId===this._ownerId?this._card.querySelector(".element__trash").style.display="block":this._card.querySelector(".element__trash").style.display="none",this._card}_checkLike(){this._likes.forEach((e=>{e._id!==this._myId||this._like.classList.add("element__group-like_active")})),this._count.textContent=this._likeLength}toggleLike(){this._like.classList.toggle("element__group-like_active")}myLikes(){return this._likes.find((e=>e._id===this._myId))}likeCount(e){this._likes=e,this._count.textContent=e.length}}class s{constructor(e){this._popup=document.querySelector(e),this._handleEscClosed=this._handleEscClose.bind(this)}open(){this._popup.classList.add("popup_opened"),document.addEventListener("keydown",this._handleEscClosed)}close(){this._popup.classList.remove("popup_opened"),document.removeEventListener("keydown",this._handleEscClosed)}_handleEscClose(e){"Escape"===e.key&&this.close()}setEventListeners(){this._popup.addEventListener("mousedown",(e=>{(e.target.classList.contains("popup_opened")||e.target.classList.contains("popup__close"))&&this.close()}))}}class i extends s{constructor(e,t){super(e),this._submitCallback=t,this._popupForm=this._popup.querySelector(".popup__form"),this._inputList=this._popupForm.querySelectorAll(".popup__input"),this._submitButton=this._popupForm.querySelector(".popup__button"),this._buttonText=this._submitButton.textContent}_getInputValues(){return this._newValues={},this._inputList.forEach((e=>{this._newValues[e.name]=e.value})),this._newValues}close(){super.close(),this._popupForm.reset()}setEventListeners(){super.setEventListeners(),this._popupForm.addEventListener("submit",(e=>{e.preventDefault(),this._submitButton.textContent="Сохранение...",this._submitCallback(this._getInputValues())}))}textChange(){this._submitButton.textContent=this._buttonText}}const n=document.querySelector(".profile__container-edit"),r=document.querySelector("#name-input"),o=document.querySelector("#info-input"),a=document.querySelector(".profile__container-add"),l=document.querySelector("form[name='popup_adding']"),h=document.querySelector("form[name='popup_profile']"),c=document.querySelector("form[name='popup_avatar']"),_=document.querySelector(".profile__avatar-edit-button"),u=new class{constructor(e){this._url=e.url,this._headers=e.headers,this._authorization=e.headers.authorization}_getResponseData(e){if(e.ok)return e.json();Promise.reject(`Ошибка: ${e.status}`)}getUserInfo(){return fetch(`${this._url}/users/me`,{headers:{authorization:this._authorization}}).then((e=>this._getResponseData(e)))}getUserCard(){return fetch(`${this._url}/cards`,{headers:{authorization:this._authorization}}).then((e=>this._getResponseData(e)))}setUserInfo(e){return fetch(`${this._url}/users/me`,{method:"PATCH",headers:this._headers,body:JSON.stringify({name:e.name,about:e.info})}).then((e=>this._getResponseData(e)))}setUserAvatar(e){return fetch(`${this._url}/users/me/avatar`,{method:"PATCH",headers:this._headers,body:JSON.stringify({avatar:e.link})}).then((e=>this._getResponseData(e)))}addCard(e){return fetch(`${this._url}/cards`,{method:"POST",headers:this._headers,body:JSON.stringify({name:e.name,link:e.link})}).then((e=>this._getResponseData(e)))}activeLike(e){return fetch(`${this._url}/cards/${e}/likes`,{method:"PUT",headers:{authorization:this._authorization}}).then((e=>this._getResponseData(e)))}inActiveLike(e){return fetch(`${this._url}/cards/${e}/likes`,{method:"DELETE",headers:{authorization:this._authorization}}).then((e=>this._getResponseData(e)))}deleteCard(e){return fetch(`${this._url}/cards/${e}`,{method:"DELETE",headers:{authorization:this._authorization}}).then((e=>this._getResponseData(e)))}}({url:"https://mesto.nomoreparties.co/v1/cohort-66",headers:{authorization:"1790fb33-a99f-4e21-b0c7-67d6836b01a4","Content-Type":"application/json"}}),d=new class extends s{constructor(e,t){super(e),this._handleClickDelete=t,this._form=this._popup.querySelector(".popup__form")}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",(e=>{e.preventDefault(),this._handleClickDelete({card:this._card,cardId:this._cardId})}))}open=e=>{let{card:t,cardId:s}=e;super.open(),this._card=t,this._cardId=s}}(".popup_config-delete",(e=>{let{card:t,cardId:s}=e;u.deleteCard(s).then((()=>{t.removeCard(),d.close()})).catch((e=>console.log(`Ошибка ${e}`)))}));d.setEventListeners();const p=e=>{const s=new t({data:e,handleCardClick:e=>{v.open(e)}},".template-cards",d.open,(()=>{s.myLikes()?u.inActiveLike(e._id).then((e=>{s.likeCount(e.likes),s.toggleLike()})).catch((e=>console.log(`Ошибка ${e}`))):u.activeLike(e._id).then((e=>{s.likeCount(e.likes),s.toggleLike()})).catch((e=>console.log(`Ошибка ${e}`)))}));return s.renderCard()},m=new class{constructor(e,t){this._renderer=e,this._container=document.querySelector(t)}render(e){e.forEach((e=>{this._renderer(e)}))}addItem(e){this._container.prepend(e)}}((e=>{m.addItem(p(e))}),".elements"),v=new class extends s{constructor(e){super(e),this._popupImage=this._popup.querySelector(".popup__image"),this._popupCaption=this._popup.querySelector(".popup__caption")}open(e){super.open(),this._popupImage.src=e.link,this._popupImage.alt=e.name,this._popupCaption.textContent=e.name}}(".popup_zoom-image");v.setEventListeners();const f=new i(".popup_card-add",(e=>{u.addCard(e).then((e=>{e.myid=e.owner._id;const t=p(e);m.addItem(t),f.close()})).catch((e=>console.log(`Ошибка ${e}`))).finally((()=>f.textChange()))}));f.setEventListeners();const k=new class{constructor(e){this._profileName=document.querySelector(e.inputNameSelector),this._profileJob=document.querySelector(e.inputJobSelector),this._profileAvatar=document.querySelector(e.avatarSelector)}getUserInfo(){return this._user={inputName:this._profileName.textContent,inputJob:this._profileJob.textContent},this._user}setUserInfo(e){let{name:t,info:s,avatar:i}=e;this._profileAvatar.src=i,this._profileName.textContent=t,this._profileJob.textContent=s}}({inputNameSelector:".profile__container-title",inputJobSelector:".profile__container-subtitle",avatarSelector:".profile__avatar"}),C=new i(".popup_open-edit",(e=>{u.setUserInfo(e).then((e=>{k.setUserInfo({name:e.name,info:e.about,avatar:e.avatar})})).catch((e=>console.log(`Ошибка ввода ${e}`))).finally((()=>C.textChange())),C.close()}));C.setEventListeners(),n.addEventListener("click",(function(){y.disableSubmitButton();const e=k.getUserInfo();r.value=e.inputName,o.value=e.inputJob,C.open()})),a.addEventListener("click",(e=>{S.disableSubmitButton(),f.open()}));const g={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__input-error_active"},y=new e(g,h);y.enableValidation();const S=new e(g,l);S.enableValidation();const b=new e(g,c),L=new i(".popup_avatar",(e=>{u.setUserAvatar(e).then((e=>{k.setUserInfo({name:e.name,info:e.about,avatar:e.avatar})})).catch((e=>console.log(`Ошибка ${e}`))).finally((()=>L.textChange())),L.close()}));L.setEventListeners(),_.addEventListener("click",(()=>{b.enableValidation(),L.open()})),Promise.all([u.getUserInfo(),u.getUserCard()]).then((e=>{let[t,s]=e;s.forEach((e=>e.myid=t._id)),k.setUserInfo({name:t.name,info:t.about,avatar:t.avatar}),m.render(s.reverse())})).catch((e=>console.log(`Ошибка ${e}`)))})();